<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEEPON</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <!-- Google Fonts ì œê±° - ì‹œìŠ¤í…œ í°íŠ¸ ì‚¬ìš© -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-left">
            <h1>ğŸ KEEPON</h1>
            <span class="header-tagline">Keep your gifts on time.</span>
        </div>
        <div class="header-right">
            <div class="family-code-section">
                <div class="code-display">
                    <span class="code-label">ê°€ì¡± ì½”ë“œ:</span>
                    <strong class="code-value" id="displayFamilyCode">-</strong>
                    <button id="copyCodeBtn" class="copy-btn" title="ì½”ë“œ ë³µì‚¬">ğŸ“‹</button>
                    <button id="copyInviteBtn" class="copy-btn" title="ì´ˆëŒ€ ë§í¬ ë³µì‚¬">ğŸ”—</button>
                </div>
            </div>
            <div class="header-buttons">
                <button id="logoutBtn" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats">
            <div class="stat-card">
                <span class="stat-icon">ğŸ</span>
                <div>
                    <div class="stat-value" id="totalGifts">0</div>
                    <div class="stat-label">ì „ì²´ ê¸°í”„íŠ¸ì½˜</div>
                </div>
            </div>
            <div class="stat-card warning">
                <span class="stat-icon">â°</span>
                <div>
                    <div class="stat-value" id="expiringGifts">0</div>
                    <div class="stat-label">ê³§ ë§Œë£Œ (D-3)</div>
                </div>
            </div>
            <!-- PCìš© ì¶”ê°€ í†µê³„ ì¹´ë“œ (ëª¨ë°”ì¼ì—ì„œëŠ” ìˆ¨ê¹€) -->
            <div class="stat-card pc-only">
                <span class="stat-icon">âœ…</span>
                <div>
                    <div class="stat-value" id="availableGifts">0</div>
                    <div class="stat-label">ì‚¬ìš©ê°€ëŠ¥</div>
                </div>
            </div>
            <div class="stat-card danger pc-only">
                <span class="stat-icon">âŒ</span>
                <div>
                    <div class="stat-value" id="expiredGifts">0</div>
                    <div class="stat-label">ë§Œë£Œë¨</div>
                </div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="actions">
            <button id="addGiftBtn" class="btn-primary">
                <span class="btn-icon">â•</span>
                ê¸°í”„íŠ¸ì½˜ ì¶”ê°€
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” ë¸Œëœë“œ ë˜ëŠ” ìƒí’ˆëª… ê²€ìƒ‰...">
            </div>
            <div class="filter-section">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                    <button class="filter-btn" data-filter="active">ì‚¬ìš©ê°€ëŠ¥</button>
                    <button class="filter-btn" data-filter="expiring">ê³§ë§Œë£Œ</button>
                    <button class="filter-btn" data-filter="expired">ë§Œë£Œë¨</button>
                </div>
            </div>
        </div>

        <!-- ê¸°í”„íŠ¸ì½˜ ëª©ë¡ -->
        <div class="gift-list" id="giftList">
            <!-- ê¸°í”„íŠ¸ì½˜ ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ë¹ˆ ìƒíƒœ -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-icon">ğŸ</div>
            <h3>ì•„ì§ ë“±ë¡ëœ ê¸°í”„íŠ¸ì½˜ì´ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì²« ë²ˆì§¸ ê¸°í”„íŠ¸ì½˜ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
        </div>
    </div>

    <!-- ê¸°í”„íŠ¸ì½˜ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="giftModal" class="modal">
        <div class="modal-content medium">
            <span class="close">&times;</span>
            <h2 id="modalTitle">ê¸°í”„íŠ¸ì½˜ ì¶”ê°€</h2>
            <form id="giftForm">
                <div class="form-group">
                    <label for="brand">ë¸Œëœë“œëª… *</label>
                    <input type="text" id="brand" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤" required>
                </div>
                <div class="form-group">
                    <label for="productName">ìƒí’ˆëª… *</label>
                    <input type="text" id="productName" placeholder="ì˜ˆ: ì•„ë©”ë¦¬ì¹´ë…¸ Tall" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="amount">ê¸ˆì•¡ (ì›) *</label>
                        <input type="number" id="amount" placeholder="5000" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">ìœ íš¨ê¸°ê°„ *</label>
                        <input type="date" id="expiryDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="barcode">ë°”ì½”ë“œ/ì¿ í°ë²ˆí˜¸</label>
                    <input type="text" id="barcode" placeholder="ì˜ˆ: 1234567890 ë˜ëŠ” ABC123DEF" maxlength="100">
                    <div id="modal-barcode" style="margin-top: 12px; padding: 12px; background: #f0fdfc; border-radius: 8px; display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="memo">ë©”ëª¨</label>
                    <textarea id="memo" placeholder="ì¶”ê°€ ì •ë³´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="status">ìƒíƒœ</label>
                    <select id="status">
                        <option value="active">ì‚¬ìš© ê°€ëŠ¥</option>
                        <option value="used">ì‚¬ìš© ì™„ë£Œ</option>
                        <option value="expired">ë§Œë£Œë¨</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
                    <button type="submit" class="btn-primary">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë°”ì½”ë“œ í™•ëŒ€ ëª¨ë‹¬ -->
    <div id="barcodeModal" class="modal">
        <div class="modal-content large">
            <span class="close" id="closeBarcodeModal">&times;</span>
            <h2 style="margin: 0 0 20px; color: #333;">ë°”ì½”ë“œ</h2>
            <div id="barcodeModalContent" style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <div id="barcodeModalInfo" style="text-align: center; color: #666; margin-bottom: 10px;"></div>
                <div id="barcodeModalBarcode" style="background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 800px; display: flex; justify-content: center;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8dNohFcINgfc60c_NMr7R7d4i3gb5yTk",
            authDomain: "newnew-a0dec.firebaseapp.com",
            projectId: "newnew-a0dec",
            storageBucket: "newnew-a0dec.firebasestorage.app",
            messagingSenderId: "143901720991",
            appId: "1:143901720991:web:e2f0cc71d182508e883daa",
            measurementId: "G-4PL9KRT445"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ì „ì—­ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
        window.db = db;
        window.auth = auth;
        window.FirebaseFirestore = { doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, orderBy, getDocs };

        // ëŒ€ì‹œë³´ë“œê°€ Firestore í˜¸ì¶œ ì „ì— ì¸ì¦ ì™„ë£Œë˜ë„ë¡ ëŒ€ê¸° Promise ì œê³µ
        window.waitForAuthUser = new Promise((resolve) => {
            onAuthStateChanged(auth, (user) => {
                resolve(user || null);
            });
        });
        
        // Firebase í•¨ìˆ˜ë“¤
        async function setupFirebaseUser(user) {
            try {
                await FirebaseFirestore.setDoc(FirebaseFirestore.doc(db, 'users', user.uid), {
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    createdAt: new Date().toISOString()
                }, { merge: true });
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
        
        async function getOrCreateFamilyCode(uid) {
            try {
                const userDoc = await FirebaseFirestore.getDoc(FirebaseFirestore.doc(db, 'users', uid));
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    if (data.familyCode) {
                        return data.familyCode;
                    }
                }
                
                // ìƒˆë¡œìš´ ê°€ì¡± ì½”ë“œ ìƒì„±
                const familyCode = generateFamilyCode();
                await FirebaseFirestore.setDoc(FirebaseFirestore.doc(db, 'users', uid), {
                    familyCode: familyCode
                }, { merge: true });
                
                return familyCode;
            } catch (error) {
                console.error('ê°€ì¡± ì½”ë“œ ìƒì„± ì‹¤íŒ¨:', error);
                return generateFamilyCode();
            }
        }
        
        function generateFamilyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.setupFirebaseUser = setupFirebaseUser;
        window.getOrCreateFamilyCode = getOrCreateFamilyCode;
    </script>
    <script src="dashboard.js"></script>
</body>
</html>

