<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEEPON</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ</text></svg>">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo-circle">
                    <div class="gift-box">ğŸ</div>
                </div>
                <h1 class="login-title">KEEPON</h1>
            </div>
            
            <div class="login-content">
                <h2 class="login-welcome-title">ë¡œê·¸ì¸</h2>
                
                <div class="login-buttons">
                    <!-- ì²« ì¤„: ë¡œê·¸ì¸ ë°©ë²• ì„ íƒ -->
                    <div class="login-row">
                        <button id="googleLoginBtn" class="login-btn-google">
                            <span class="google-icon">ğŸ”µ</span>
                            êµ¬ê¸€ ë¡œê·¸ì¸
                        </button>
                        <button id="familyCodeBtn" class="login-btn-primary">
                            ê°€ì¡±ì½”ë“œ ì…ë ¥
                        </button>
                    </div>
                    
                    <!-- ë‘ ë²ˆì§¸ ì¤„: íšŒì›ê°€ì… -->
                    <button id="googleSignUpBtn" class="login-btn-signup">
                        <span class="google-icon">ğŸ”µ</span>
                        íšŒì›ê°€ì…
                    </button>
                </div>
            </div>
        </div>
        
        <div class="login-external-footer">
            <p class="login-footer-text">Keep your gifts on time.</p>
            <p class="login-footer-tagline">â¤ï¸ ê°€ì¡±ì´ í•¨ê»˜ ì“°ëŠ” ì„ ë¬¼ ì§€ê°‘</p>
        </div>
    </div>
    
    <!-- í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast" class="toast-message"></div>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyC8dNohFcINgfc60c_NMr7R7d4i3gb5yTk",
            authDomain: "newnew-a0dec.firebaseapp.com",
            projectId: "newnew-a0dec",
            storageBucket: "newnew-a0dec.firebasestorage.app",
            messagingSenderId: "143901720991",
            appId: "1:143901720991:web:e2f0cc71d182508e883daa",
            measurementId: "G-4PL9KRT445"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
        const googleLoginBtn = document.getElementById('googleLoginBtn');
        const googleSignUpBtn = document.getElementById('googleSignUpBtn');
        const familyCodeBtn = document.getElementById('familyCodeBtn');
        
        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast-message show toast-${type}`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // êµ¬ê¸€ ë¡œê·¸ì¸
        googleLoginBtn.addEventListener('click', async () => {
            try {
                showToast('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘...', 'info');
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ:', user);
                
                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                const { getFirestore, doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore(app);
                
                // ì‚¬ìš©ì ë¬¸ì„œê°€ ìˆëŠ”ì§€ í™•ì¸
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    // ì‹ ê·œ ì‚¬ìš©ì - ê°€ì¡± ì½”ë“œ ìƒì„±
                    const familyCode = generateFamilyCode();
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        familyCode: familyCode,
                        isCodeOwner: true,
                        createdAt: new Date().toISOString()
                    });
                    showToast('íšŒì›ê°€ì… ì™„ë£Œ! ê°€ì¡± ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    // ê¸°ì¡´ ì‚¬ìš©ì - ì—…ë°ì´íŠ¸
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        lastLogin: new Date().toISOString()
                    }, { merge: true });
                    showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                }
                
                localStorage.setItem('user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
            } catch (error) {
                console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì—ëŸ¬:', error);
                let errorMsg = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                if (error.code === 'auth/unauthorized-domain') {
                    errorMsg = 'ë„ë©”ì¸ì´ í—ˆìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMsg = 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.';
                }
                showToast(errorMsg, 'error');
            }
        });
        
        function generateFamilyCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // êµ¬ê¸€ íšŒì›ê°€ì…
        googleSignUpBtn.addEventListener('click', async () => {
            try {
                showToast('êµ¬ê¸€ íšŒì›ê°€ì… ì¤‘...', 'info');
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;
                
                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
                const { getFirestore, doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore(app);
                
                // ì‚¬ìš©ì ë¬¸ì„œ í™•ì¸
                const userDocRef = doc(db, 'users', user.uid);
                const userDoc = await getDoc(userDocRef);
                
                if (!userDoc.exists()) {
                    // ì‹ ê·œ íšŒì›ê°€ì… - ê°€ì¡± ì½”ë“œ ìƒì„±
                    const familyCode = generateFamilyCode();
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        familyCode: familyCode,
                        isCodeOwner: true,
                        createdAt: new Date().toISOString()
                    });
                    showToast('íšŒì›ê°€ì… ì™„ë£Œ! ê°€ì¡± ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showToast('ì´ë¯¸ íšŒì›ê°€ì…ëœ ê³„ì •ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•©ë‹ˆë‹¤.', 'success');
                }
                
                localStorage.setItem('user', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
                
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
            } catch (error) {
                console.error('êµ¬ê¸€ íšŒì›ê°€ì… ì—ëŸ¬:', error);
                showToast('íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });
        
        // ê°€ì¡±ì½”ë“œ ì…ë ¥
        familyCodeBtn.addEventListener('click', () => {
            openFamilyCodeModal();
        });
        
        function openFamilyCodeModal() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;';
            
            const form = document.createElement('div');
            form.style.cssText = 'background:white;padding:30px;border-radius:12px;width:90%;max-width:400px;';
            form.innerHTML = `
                <h3 style="margin:0 0 20px;color:#333;">ê°€ì¡± ì§€ê°‘ ì…ì¥</h3>
                <input type="text" id="familyCodeInput" placeholder="ê°€ì¡± ì½”ë“œ (6ì)" maxlength="6" 
                       style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:16px;text-transform:uppercase;margin-bottom:20px;">
                <div style="display:flex;gap:10px;">
                    <button id="submitCode" style="flex:1;padding:12px;background:#00C9A7;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">ì…ì¥</button>
                    <button id="cancelCode" style="flex:1;padding:12px;background:#f0f0f0;border:none;border-radius:8px;cursor:pointer;">ì·¨ì†Œ</button>
                </div>
            `;
            
            modal.appendChild(form);
            document.body.appendChild(modal);
            
            const closeModal = () => document.body.removeChild(modal);
            
            modal.querySelector('#cancelCode').addEventListener('click', closeModal);
            modal.querySelector('#submitCode').addEventListener('click', async () => {
                await handleFamilyCodeSubmit(modal);
            });
        }
        
        async function handleFamilyCodeSubmit(modal) {
            const code = modal.querySelector('#familyCodeInput').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                showToast('ê°€ì¡± ì½”ë“œëŠ” 6ìì—¬ì•¼ í•©ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            try {
                showToast('ê°€ì¡± ì½”ë“œ í™•ì¸ ì¤‘...', 'info');
                
                // Firestoreì—ì„œ ê°€ì¡± ì½”ë“œ í™•ì¸
                const { getFirestore, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const db = getFirestore(app);
                
                const q = query(collection(db, 'users'), where('familyCode', '==', code), where('isCodeOwner', '==', true));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const ownerDoc = querySnapshot.docs[0];
                    const ownerData = ownerDoc.data();
                    
                    // ê°€ì¡± ì§€ê°‘ ì…ì¥ ì •ë³´ ì €ì¥ (ë¸Œë¼ìš°ì € ë¡œì»¬ìŠ¤í† ë¦¬ì§€ë§Œ ì‚¬ìš©)
                    localStorage.setItem('familyCode', code);
                    localStorage.setItem('ownerEmail', ownerData.email);
                    localStorage.setItem('isFamilyMember', 'true');
                    localStorage.setItem('loginMethod', 'familyCode'); // ë¡œê·¸ì¸ ë°©ì‹ ì €ì¥
                    
                    showToast('ê°€ì¡± ì§€ê°‘ì— ì…ì¥í•©ë‹ˆë‹¤...', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } else {
                    showToast('ìœ íš¨í•˜ì§€ ì•Šì€ ê°€ì¡± ì½”ë“œì…ë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ê°€ì¡± ì½”ë“œ í™•ì¸ ì—ëŸ¬:', error);
                showToast('ê°€ì¡± ì½”ë“œ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        // ì£¼ì„ ì²˜ë¦¬: íšŒì›ê°€ì… í˜ì´ì§€ê°€ í•­ìƒ ë³´ì´ë„ë¡
        /*
        const savedUser = localStorage.getItem('user');
        const savedCode = localStorage.getItem('familyCode');
        if (savedUser || savedCode) {
            window.location.href = 'dashboard.html';
        }
        */
    </script>
  </body>
</html>
